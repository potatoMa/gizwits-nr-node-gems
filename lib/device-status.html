<script type="text/javascript">
  var operators = [
    {v:"eq",t:"==",kind:'V'},
    {v:"neq",t:"!=",kind:'V'},
    {v:"lt",t:"<",kind:'V'},
    {v:"lte",t:"<=",kind:'V'},
    {v:"gt",t:">",kind:'V'},
    {v:"gte",t:">=",kind:'V'},
  ];
  const getProduct = (gizwitsServer) => {
    console.log(gizwitsServer, 'gizwitsServergizwitsServer')
    if (gizwitsServer.aepUrl) {
      $.ajax({
        url: `${gizwitsServer.aepUrl}/product/product/list`,
        contentType: "application/json;charset=utf-8",
        type: 'post',
        headers: {
          Authorization: 'e39d772f-5e4a-4303-800e-b64ad1cea196'
        },
        crossDomain: true,
        dataType: 'json',
        data: JSON.stringify({
          appKey: 'sdsddfasdfasdfsdfasfdsf',
          data: {
            asc: false,
            orderByField: 'utime',
            current: 1,
            size: 100
          },
          version: '1.0'
        }),
        success: function (data) {
          console.log(data)
        }
      });
    }
  }
  RED.nodes.registerType('device status',{
      category: 'gizwits',
      color:"#C0DEED",
      defaults: {
          server: {type:"GizwitsServer",required:true},
          product: {value:""},
          user: {value:"false",required:true},
          name: {value:""},
      },
      inputs: 0,
      outputs: 1,
      icon: "twitter.png",
      label: function() {
          return '设备状态变化';
      },
      oneditresize: function() {
        console.log('oneditresize')
      },
      oneditprepare: function() {
        // 渲染运算符
        var row = $('#node-input-rule-container');
        var selectField = $('<select/>',{style:"width:120px; text-align: center;"}).appendTo(row);
        var group0 = $('<optgroup/>', { label: "value rules" }).appendTo(selectField);
        for (var d in operators) {
          if(operators[d].kind === 'V') {
            group0.append($("<option></option>").val(operators[d].v).text(operators[d].t));
          }
        }
        // 结果值
        $("#node-input-dataPointValue").typedInput({
          type:"str",
          types:["str","num","bool"],
          typeField: "#node-input-dataPointValue-type"
        });
        // 监听服务变化，获取产品
        $('#node-input-server').on('change', (e) => {
          const serverId = e.target.value;
          if (serverId && serverId !== '_ADD_') {
            const gizwitsServer = localStorage.getItem(`gizwitsServer-${serverId}`);
            if (gizwitsServer) {
              getProduct(JSON.parse(gizwitsServer));
            }
          }
        })
      },
      oneditsave: function() {
        console.log('oneditsave')
      },
  });
</script>

<script type="text/html" data-template-name="device status">
  <div class="form-row">
    <label for="node-input-server"><i class="fa fa-user"></i> <span>机智云服务</span></label>
    <input type="text" id="node-input-server">
  </div>
  <div class="form-row">
    <label for="node-input-product"><i class="fa fa-search"></i> 选择产品</label>
    <select type="text" id="node-input-user" style="display: inline-block; vertical-align: middle; width:70%;">
      <option value="false"></option>
      <option value="true"></option>
      <option value="user"></option>
      <option value="dm"></option>
    </select>
  </div>
  <div class="form-row" id="node-input-tags-row">
    <label for="node-input-tags"><i class="fa fa-tags"></i> 选择设备</label>
    <input type="text" id="node-input-tags">
  </div>
  <div class="form-row">
    <label for="node-input-dataPoint"><i class="fa fa-tags"></i> 数据点</span></label>
    <input type="text" id="node-input-dataPoint">
  </div>
  <div class="form-row node-input-rule-container-row">
    <label for="node-input-dataPoint"><i class="fa fa-tags"></i> 判断条件</span></label>
    <div style="display: inline-block" id="node-input-rule-container"></div>
    <input type="text" id="node-input-dataPointValue">
    <input type="hidden" id="node-input-dataPointValue-type">
  </div>
</script>